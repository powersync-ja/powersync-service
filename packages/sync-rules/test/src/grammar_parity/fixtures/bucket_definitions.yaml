parameters:
  accepted:
    - sql: SELECT token_parameters.user_id AS user_id
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.id = token_parameters.user_id
    - sql: SELECT json_each.value AS tag FROM json_each(request.parameters() -> 'tags')
    - sql: SELECT request.user_id() AS user_id
    - sql: SELECT request.parameter('tenant_id') AS tenant_id
    - sql: SELECT request.parameters() ->> 'org_id' AS org_id
    - sql: SELECT request.jwt() ->> 'sub' AS sub
    - sql: SELECT CAST(token_parameters.user_id AS text) AS user_id
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.id = request.user_id()
    - sql: SELECT users.org_id AS org_id FROM test_schema.users WHERE users.id = token_parameters.user_id
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.id = request.parameter('user_id')
    - sql: SELECT json_each.value AS tag FROM json_each(request.parameter('tags'))
    - sql: SELECT json_each.value AS tag FROM json_each(request.parameters() -> 'tags') WHERE json_each.value IS NOT NULL
    - sql: SELECT token_parameters.user_id || '' AS user_id
    - sql: SELECT (token_parameters.user_id) AS user_id
    - sql: SELECT request.parameters() -> 'profile' AS profile
    - sql: SELECT request.parameter('features') ->> 'beta' AS beta
    - sql: SELECT CAST(request.parameter('limit') AS integer) AS limit_value
    - sql: SELECT token_parameters.user_id AS user_id WHERE request.user_id() IS NOT NULL
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.id = token_parameters.user_id AND token_parameters.user_id IS NOT NULL
    - sql: SELECT CAST(request.parameters() ->> 'org_id' AS text) AS org_id
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.id = request.user_id() AND users.is_admin = TRUE
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.owner_id = request.user_id() OR users.shared_with = request.user_id()
    - sql: SELECT users.org_id AS org_id FROM users WHERE NOT users.is_admin = TRUE

  rejected_syntax:
    # table aliases are not supported in parameter queries
    # parser: Table aliases not supported in parameter queries
    - sql: SELECT u.org_id AS org_id FROM users u WHERE u.id = token_parameters.user_id
      err: alias

    # double quotes denote identifiers, not string literals
    - sql: SELECT request.parameter("tenant_id") AS tenant_id

    # only json_each(...) table-valued functions are supported
    # parser: Table-valued function generate_series is not defined.
    - sql: SELECT x FROM generate_series(1, 3) AS x
      err: not defined

    # parser: LIMIT is not supported
    - sql: SELECT token_parameters.user_id AS user_id LIMIT 1
      err: LIMIT

  rejected_semantic:
    # parser: Left and right sides of OR must use the same parameters, or split into separate queries. [{"key":"token_parameters.user_id","expands":false}] != [{"key":"request.user_id()","expands":false}]
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.id = token_parameters.user_id OR users.id = request.user_id()
      err: same parameters

    # OR sides reference different parameters
    # parser: Left and right sides of OR must use the same parameters, or split into separate queries. [{"key":"request.user_id()","expands":false}] != [{"key":"token_parameters.org_id","expands":false}]
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.owner_id = request.user_id() OR users.org_id = token_parameters.org_id
      err: same parameters

    # two IN expressions in one AND
    # parser: Cannot have multiple array input parameters
    - sql: SELECT users.org_id AS org_id FROM users WHERE users.id IN token_parameters.list_ids AND users.org_id IN token_parameters.org_ids
      err: multiple array input parameters

data:
  accepted:
    - sql: SELECT id FROM assets
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id
      params: [user_id]
    - sql: SELECT id, name FROM assets WHERE owner_id = bucket.user_id
      params: [user_id]
    - sql: SELECT assets.id AS id FROM assets WHERE assets.owner_id = bucket.user_id
      params: [user_id]
    - sql: SELECT id FROM assets WHERE bucket.user_id = owner_id
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND id IS NOT NULL
      params: [user_id]
    - sql: SELECT id, name AS asset_name FROM assets WHERE owner_id = bucket.user_id
      params: [user_id]
    - sql: SELECT id FROM test_schema.assets WHERE owner_id = bucket.user_id
      params: [user_id]
    - sql: SELECT id FROM assets WHERE (owner_id = bucket.user_id)
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id OR bucket.user_id = owner_id
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND (name IS NOT NULL)
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND id = id
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND (owner_id = bucket.user_id)
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND (owner_id IS NOT NULL)
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND (name = name)
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND (id = id)
      params: [user_id]
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND (owner_id = bucket.user_id OR other_id = bucket.user_id)
      params: [user_id]
    - sql: SELECT id FROM assets WHERE status = 'active'
    - sql: SELECT id FROM assets WHERE deleted_at IS NULL
    - sql: SELECT id FROM assets WHERE status != 'archived'
    - sql: SELECT id FROM assets WHERE deleted_at IS NOT NULL
    - sql: SELECT id FROM assets WHERE category IN '["draft", "hidden"]'

  rejected_syntax:
    # parser: Must SELECT from a single table
    - sql: SELECT assets.id FROM assets JOIN users ON users.id = assets.owner_id
      err: single table

    # NOT IN with fixed value list
    # parser: list not supported here
    - sql: SELECT id FROM assets WHERE category NOT IN ('draft', 'hidden')
      err: list not supported here
    - sql: SELECT id FROM assets WHERE category NOT IN '["draft", "hidden"]'

    - sql: SELECT id FROM assets WHERE category IN ('draft', 'hidden')

  rejected_semantic:
    # parser: alias is required
    - sql: SELECT upper(name) FROM assets
      err: alias

    # missing owner_id = bucket.user_id condition
    # parser: Query must cover all bucket parameters. Expected: ["bucket.user_id"] Got: []
    - sql: SELECT id FROM assets
      params: [user_id]
      err: cover all bucket parameters

    # parser: Cannot use bucket parameters in expressions
    - sql: SELECT id FROM assets WHERE NOT (owner_id != bucket.user_id)
      params: [user_id]
      err: bucket parameters in expressions

    # parser: Cannot use bucket parameters in expressions
    - sql: SELECT id FROM assets WHERE owner_id = bucket.user_id AND (bucket.user_id IS NOT NULL)
      params: [user_id]
      err: bucket parameters in expressions
